# Backend API Documentation: Section Edit Endpoint

## Keep-On Edit Function - Research Section Editor

### Endpoint
```
POST /fact-check/{session_id}/edit-section/
```

### Purpose
Enables users to interactively edit and refine specific H2 sections within research reports using AI assistance. Users can click on any H2 heading (identified by always-visible edit icons ✏️) to open an editing modal where they provide instructions for how the AI should improve, expand, or refine that specific section.

### Feature Overview
The Keep-On Edit function provides an intuitive interface for research report refinement:
- **Always-visible edit icons** next to H2 headings indicate editable sections
- **Click-to-edit interaction** - users click anywhere on an H2 heading to edit
- **Contextual modal** appears next to the clicked heading
- **AI-powered refinement** based on user instructions
- **Seamless section replacement** in the research report

### Request Format

#### URL Parameters
- `session_id` (string, required): The unique identifier for the research session

#### Request Body (JSON)
```json
{
  "section_id": "string",
  "section_title": "string", 
  "original_content": "string",
  "edit_prompt": "string",
  "full_report": "string"
}
```

#### Request Body Fields

**`section_id`** (string, required)
- The unique identifier for the section (e.g., "heading-1-introduction")
- Generated by the frontend when processing H2 headings
- Used to identify which section to replace in the final report

**`section_title`** (string, required)
- The text content of the H2 heading (e.g., "Introduction", "Key Findings")
- Used by AI to understand the context and purpose of the section

**`original_content`** (string, required) 
- The original markdown content of the section including the H2 heading
- Everything from the H2 heading up to (but not including) the next H2 heading
- Provides full context to the AI for editing

**`edit_prompt`** (string, required)
- User's instructions for how to refine/improve the section
- Examples: "Make this more detailed", "Add more recent examples", "Simplify the language"
- Should be descriptive and actionable

**`full_report`** (string, required)
- The complete research report markdown content
- Provides broader context to maintain consistency with the overall report
- Ensures edited section fits well with the rest of the content

### Example Request
```json
{
  "section_id": "heading-1-benefits-of-renewable-energy",
  "section_title": "Benefits of Renewable Energy",
  "original_content": "## Benefits of Renewable Energy\n\nRenewable energy sources offer several advantages over fossil fuels.\n\n- Reduced carbon emissions\n- Lower long-term costs\n- Energy independence",
  "edit_prompt": "Expand this section with more specific examples and recent statistics about cost savings and environmental impact",
  "full_report": "# Research Report: Renewable Energy\n\n## Introduction\n...\n\n## Benefits of Renewable Energy\n...\n\n## Challenges\n..."
}
```

### Response Format

#### Success Response (200 OK)
```json
{
  "status": "success",
  "updated_section": "string",
  "processing_time": "number"
}
```

#### Response Fields

**`status`** (string)
- Always "success" for successful requests

**`updated_section`** (string)
- The AI-generated improved section content in markdown format
- Includes the H2 heading and all content up to the next section
- Ready to replace the original section in the full report

**`processing_time`** (number)
- Time taken to process the edit request in seconds
- For monitoring and analytics purposes

### Example Response
```json
{
  "status": "success",
  "updated_section": "## Benefits of Renewable Energy\n\nRenewable energy sources provide significant advantages over traditional fossil fuels, supported by compelling data and real-world implementations.\n\n### Environmental Impact\n- **Carbon Emission Reduction**: Solar and wind power produce 90-95% fewer carbon emissions than coal plants\n- **Air Quality Improvement**: Renewable energy prevents approximately 12,700 premature deaths annually in the US\n\n### Economic Benefits\n- **Cost Competitiveness**: Solar costs have dropped 85% since 2010, now cheaper than coal in most markets\n- **Job Creation**: The renewable energy sector employed 12 million people globally in 2020\n- **Energy Price Stability**: Renewable sources provide predictable long-term energy costs\n\n### Energy Security\n- **Domestic Resource Utilization**: Reduces dependence on volatile fossil fuel imports\n- **Grid Resilience**: Distributed renewable systems improve overall grid stability",
  "processing_time": 3.2
}
```

### Error Responses

#### 400 Bad Request
```json
{
  "status": "error",
  "error": "Invalid request format",
  "details": "Missing required field: edit_prompt"
}
```

#### 404 Not Found
```json
{
  "status": "error", 
  "error": "Session not found",
  "details": "No research session found with ID: abc123"
}
```

#### 500 Internal Server Error
```json
{
  "status": "error",
  "error": "AI processing failed",
  "details": "Unable to process edit request due to AI service timeout"
}
```

### Implementation Requirements

#### Backend Processing Flow
1. **Validate Request**: Ensure all required fields are present and session exists
2. **Extract Context**: Parse the original content and full report for context
3. **AI Processing**: Send the section content, edit prompt, and context to AI service
4. **Content Generation**: AI generates improved section content based on user instructions
5. **Quality Validation**: Ensure generated content maintains markdown structure and coherence
6. **Response Formation**: Return the updated section ready for frontend integration

#### AI Prompt Engineering
The AI should receive a prompt structured like:
```
You are editing a section of a research report. 

SECTION TO EDIT:
{original_content}

EDIT INSTRUCTIONS:
{edit_prompt}

FULL REPORT CONTEXT:
{full_report}

Please provide an improved version of the section that:
1. Addresses the user's edit instructions
2. Maintains the same markdown structure (H2 heading + content)
3. Stays consistent with the overall report tone and style
4. Provides accurate, well-researched information
5. Uses proper markdown formatting

Return ONLY the updated section content.
```

#### Security Considerations
- Validate session ownership to prevent unauthorized edits
- Sanitize user input to prevent injection attacks
- Rate limit requests to prevent abuse
- Log edit activities for audit purposes

#### Performance Requirements
- Target response time: < 5 seconds for typical section edits
- Support concurrent edit requests from different sessions
- Implement proper error handling and timeout management

### Frontend Integration

The frontend implementation includes:

#### **Visual Indicators**
1. **Always-visible edit icons** (✏️) next to all H2 headings at 60% opacity
2. **Hover enhancement** - icons scale to 120% and become fully opaque
3. **Full heading interaction** - entire H2 heading is clickable with background highlight
4. **Clean table of contents** - edit icons are filtered out of navigation

#### **User Interaction Flow**
1. **Section Identification** - H2 headings display persistent edit icons
2. **Click-to-Edit** - clicking anywhere on H2 heading opens edit modal
3. **Contextual Modal** - appears positioned next to the clicked heading
4. **Animated Transitions** - smooth modal opening with scale and slide effects
5. **Section Updates** - edited content seamlessly replaces original section

#### **Technical Implementation**
1. Extract section content and IDs from rendered markdown using DOM parsing
2. Position edit modal relative to clicked heading for contextual editing
3. Handle loading states with animated spinner and disabled interactions
4. Update displayed report content and maintain scroll position
5. Clean text extraction for table of contents (removes edit icons)
6. Preserve full markdown structure in updated content

### Testing Recommendations

#### Unit Tests
- Validate request parsing and field validation
- Test error handling for various failure scenarios
- Verify response format consistency

#### Integration Tests  
- End-to-end workflow from section selection to report update
- AI service integration and response handling
- Session persistence and state management

#### User Acceptance Tests
- Section editing for various content types and lengths
- Edit prompt variations and AI response quality
- UI responsiveness and user experience flow
- Always-visible edit icon functionality across different screen sizes
- Modal positioning and animation smoothness
- Table of contents accuracy (without edit icons)

### Production Deployment Notes

#### **Database Considerations**
- Track section edit history for analytics and user behavior insights
- Store original and edited section content for rollback capabilities
- Monitor edit request patterns to optimize AI prompt engineering

#### **Performance Monitoring**
- Track edit request frequency and section types most commonly edited
- Monitor AI processing times for different section sizes and complexity
- Analyze user satisfaction with edited content quality

#### **Feature Analytics**
- Measure edit icon discovery rate (how quickly users find the feature)
- Track edit modal completion vs abandonment rates
- Monitor section re-editing frequency (users editing same section multiple times)